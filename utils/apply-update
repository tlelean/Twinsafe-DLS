#!/usr/bin/env bash
# Moves the staged DLS.app and DLS.crc (and visu contents) into place, then restarts Codesys.

set -euo pipefail

SRC_DIR="/var/opt/codesys/PlcLogic/DLS/Updates"
DST_DIR="/var/opt/codesys/PlcLogic/DLS"
VISU_SRC="$SRC_DIR/visu"
VISU_DST="/var/opt/codesys/PlcLogic/visu"
SERVICE="codesyscontrol.service"

APP_SRC="$SRC_DIR/DLS.app"
CRC_SRC="$SRC_DIR/DLS.crc"
APP_DST="$DST_DIR/DLS.app"
CRC_DST="$DST_DIR/DLS.crc"

# --- sanity checks ---
if [ ! -f "$APP_SRC" ] || [ ! -f "$CRC_SRC" ]; then
    echo "‚ùå Missing update files."
    echo "Expected:"
    echo "  $APP_SRC"
    echo "  $CRC_SRC"
    exit 1
fi

echo "üîÑ Moving DLS.app and DLS.crc into place..."
sudo mv -f "$APP_SRC" "$APP_DST"
sudo mv -f "$CRC_SRC" "$CRC_DST"

# --- handle visu ---
if [ -d "$VISU_SRC" ]; then
    echo "üñ•Ô∏è  Updating visu files..."
    sudo mkdir -p "$VISU_DST"
    # Copy all visu contents (overwrite, preserve structure)
    sudo rsync -a --delete "$VISU_SRC"/ "$VISU_DST"/
    # Optional: clean up visu source folder
    sudo rm -rf "$VISU_SRC"
else
    echo "‚ÑπÔ∏è  No visu folder found in updates ‚Äî skipping visu copy."
fi

echo "‚ôªÔ∏è Restarting $SERVICE..."
sudo systemctl restart "$SERVICE"

if systemctl is-active --quiet "$SERVICE"; then
    echo "‚úÖ Update applied successfully and $SERVICE restarted."
else
    echo "‚ö†Ô∏è Files moved, but $SERVICE failed to start. Check logs with:"
    echo "   journalctl -u $SERVICE -xe"
    exit 2
fi